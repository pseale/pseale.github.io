<!doctype html>
<html lang="en-us">
  <head>
    <title>DevSecFailureOps</title>
    
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.92.1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Peter Seale" />
    <meta name="description" content="DevSecFailureOps: the intersection of Development, InfoSec, Operations, and also mortifying, pervasive Failure" />
    <link rel="stylesheet" href="https://devsecfailureops.com/hot-takes/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="DevSecFailureOps"/>
<meta name="twitter:description" content="DevSecFailureOps: the intersection of Development, InfoSec, Operations, and also mortifying, pervasive Failure"/>

    <meta property="og:title" content="DevSecFailureOps" />
<meta property="og:description" content="DevSecFailureOps: the intersection of Development, InfoSec, Operations, and also mortifying, pervasive Failure" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://devsecfailureops.com/hot-takes/" />



    <style>
       

      header.app-header {
        padding: 3em;
        margin: -1.5em;
        yes-this-was-on-purpose: 1;  
      }

       
      @media (max-width:940px)  {
        main.app-container {
          padding: 2px;
          margin: 2px;
        }
        header.app-header {
          padding: 0;
          margin: 0;
          yes-this-was-on-purpose: 1;  
        }
      }

      body {
        font-size: 16px;
        color: #d6e3ef;
      }

      body strong {
        color: #fff;
      }

      h2 {
        margin-bottom: 0;
      }
      a h2.post-title {
        text-decoration: underline;
      }

      li.posts-list-item {
        padding-bottom: 25px;
      }

      h5 {
        border: 1px solid white;
        margin: 5px 0;
        padding-left: 5px;
        background: #57cc8a;
      }
      code {
        color: rgb(206 217 227);  
        background-color: #4b525c;  
        padding: 2px;
      }
      div.highlight code {
        background-color: inherit;  
        padding: 0;
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <a href="https://devsecfailureops.com/hot-takes/"><img class="app-header-avatar" src="/hot-takes/avatar-dignified-400x400.jpg" alt="Peter Seale" /></a>
      <h1>DevSecFailureOps</h1>

      <p>DevSecFailureOps: the intersection of Development, InfoSec, Operations, and also mortifying, pervasive Failure</p>
      <div class="app-header-social">
        
          <a href="https://github.com/pseale" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>GitHub</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://twitter.com/pseale" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>Twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
          </a>
        
      </div>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/hot-takes/posts/standard-disclaimer">Standard disclaimer</a>
      </nav>
    </header>
    <main class="app-container">
      
  <div>
    <ul class="posts-list">
      
        <li class="posts-list-item">
          <article class="post">
            <header class="post-header">
              <a class="posts-list-item-title" href="https://devsecfailureops.com/hot-takes/posts/terraform-surgeon-generals-warning/"><h2 class ="post-title">Terraform Data Blocks: Surgeon General&#39;s Warning</h2></a>
              <div class="post-meta">
                <div>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
                  
                </div>
              </div>
            </header>
            <div class="post-content">
              <h5 id="spicy-peppers-rating-system-----one-pepper--bold-and-zesty-potentially-misinformation">Spicy Peppers Rating System | 🌶 - One Pepper | Bold and Zesty; Potentially Misinformation</h5>



<div style="border: solid black 4px; max-width: 850px; padding: 10px 15px; background: white; color: black; font-size: 1.5em; line-height: 1.2em; text-align: center; margin-top: 25px">
SURGEON GENERAL'S WARNING: Quitting <span style="color: #111; font-family: serif; font-weight: bold; font-style: italic">DATA BLOCKS</span> Now Greatly Reduces Serious Risks to Your <span style="color: #111; font-family: serif; font-weight: bold; font-style: italic">TERRAFORM INFRASTRUCTURE</span>.
</div>



<h3 id="summary">Summary</h3>
<p>Data blocks (Terraform Data sources) appear harmless, but aren&rsquo;t. This is because every resource that relies on a data block is in danger of being replaced, because in some circumstances, data blocks are evaluated <strong>after apply</strong>. It&rsquo;s just a matter of time.</p>
<p>I know the summary above didn&rsquo;t make sense, so read on.</p>
<h3 id="data-blocks-explained">Data blocks explained</h3>
<p>Data blocks, or <a href="https://www.terraform.io/language/data-sources">data sources</a> in Hashicorp&rsquo;s parlance, are a convenient way to get at information. As a wise man once told me, data blocks are basically API calls (that retrieve data). I&rsquo;ll refer to data sources as data blocks because in the code they are a <code>data {}</code> block.</p>
<p>If you&rsquo;re entirely unfamiliar with them, Hashicorp docs provide a <a href="https://www.terraform.io/language/data-sources">a good overview</a>.</p>
<p>As I&rsquo;ve discovered, data blocks are convenient right up until Terraform wants to replace <strong>the entire Kubernetes cluster</strong>. Did I mention it was <strong>the entire Kubernetes cluster</strong>? Not just a node pool, no, <strong>the entire Kubernetes cluster</strong>. And as bad as that sounds, it was worse, actually&ndash;yes, it was <strong>the entire Kubernetes cluster</strong>, but it was most everything else, too.</p>
<h3 id="the-danger-by-example">The danger, by example</h3>
<p><a href="https://github.com/hashicorp/terraform/issues/28377">This remarkably friendly GitHub issue</a> details the danger better than I can, but I&rsquo;ll try anyway, with the minimum possible example. An MVP of failure, if you will.</p>
<p>In this example, we have two things:</p>
<ul>
<li>not managed by terraform: a subnet <code>subnet1</code></li>
<li>managed by terraform: a network interface (think NIC, but in the cloud) which lives on the subnet</li>
</ul>
<h4 id="the-beginning-no-data-blocks-no-problems">The Beginning: No Data Blocks, No Problems</h4>
<p>In the beginning, we&rsquo;ll start with no frills and no data blocks.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#75715e">######################################
</span><span style="color:#75715e">## The Beginning: No Data Blocks
</span><span style="color:#75715e">######################################
</span><span style="color:#75715e">
</span><span style="color:#75715e"># subnet already exists, not managed by terraform
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;azurerm_network_interface&#34; &#34;example&#34;</span> {<span style="color:#75715e">
</span><span style="color:#75715e">  # note it&#39;s a hardcoded string - a potential DRY violation! Call the cops
</span><span style="color:#75715e"></span>  subnet_id      <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/examplerg/providers/Microsoft.Network/virtualNetworks/examplevnet/subnets/subnet1&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">
</span><span style="color:#75715e">  # ... (details omitted)
</span><span style="color:#75715e"></span>}
</code></pre></div><p>This creates a network interface that is placed on <code>subnet1</code>.</p>
<p>And it works great! To specify which subnet to place the <code>azurerm_network_interface</code> in, we&rsquo;ve hardcoded the <code>subnet_id</code>. This works, it&rsquo;s safe, and any potential mistakes can be discovered during a <code>terraform plan</code>. As for downsides: this giant ugly ID is ugly? And hard to read?</p>
<p>So here&rsquo;s what we did next, for a little bit of convenience. Let&rsquo;s call this scenario Trouble Ahead: Storm&rsquo;s A-brewin'.</p>
<h4 id="trouble-ahead-data-block-introduced">Trouble Ahead: Data Block Introduced</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#75715e">######################################
</span><span style="color:#75715e">## Trouble Ahead: Data Block Introduced For Convenience
</span><span style="color:#75715e">######################################
</span><span style="color:#75715e">
</span><span style="color:#75715e"># subnet already exists - thus we reference it as a &#39;data&#39; block
</span><span style="color:#75715e"></span><span style="color:#66d9ef">data</span> <span style="color:#e6db74">&#34;azurerm_subnet&#34; &#34;example&#34;</span> {
  name                 <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">subnet_name</span>
  resource_group_name  <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">resource_group_name</span>
  virtual_network_name <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">virtual_network_name</span>
}

<span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;azurerm_network_interface&#34; &#34;example&#34;</span> {<span style="color:#75715e">
</span><span style="color:#75715e">  # note subnet_id is bound to a data block
</span><span style="color:#75715e"></span>  subnet_id      <span style="color:#f92672">=</span> <span style="color:#66d9ef">data</span>.<span style="color:#66d9ef">azurerm_subnet</span>.<span style="color:#66d9ef">example</span>.<span style="color:#66d9ef">id</span><span style="color:#75715e">
</span><span style="color:#75715e">
</span><span style="color:#75715e">  # ... (details omitted)
</span><span style="color:#75715e"></span>}
</code></pre></div><p>The network interface is still placed on <code>subnet1</code>, but we&rsquo;ve avoided using the full, ugly ID for <code>subnet1</code>, and instead use variables (which we presumably use elsewhere anyways).</p>
<p>While this works perfectly on the initial <code>terraform apply</code>, we are now in potential future danger of replacing our <code>azurerm_network_interface</code> resource.</p>
<p>The danger is not immediate&ndash;so far, we&rsquo;re still safe. To fall fully into the trap, we need to do a few specific things:</p>
<ul>
<li>Use a data block in a module</li>
<li>Use outputs from that module</li>
<li>Explicitly <code>depends_on</code> that module</li>
</ul>
<p>And let me be clear that because no one on my team knew to avoid this, we built the terraform in such a way that <strong>the majority of our infrastructure</strong> was affected by such an issue. It&rsquo;s not that difficult to do. Use data blocks freely and introduce modules as your terraform grows. In just a short time, you&rsquo;ll be in trouble, just like me!</p>
<p>Let&rsquo;s see what such a disaster looks like:</p>
<h3 id="imminent-doom-dont-hit-that-apply-button">Imminent Doom: Don&rsquo;t Hit That Apply Button</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#75715e">######################################
</span><span style="color:#75715e">## Imminent Doom: Data Block + Module + depends_on
</span><span style="color:#75715e">######################################
</span><span style="color:#75715e">
</span><span style="color:#75715e"># ~~~~~~ vnet module.tf ~~~~~~
</span><span style="color:#75715e"></span><span style="color:#66d9ef">data</span> <span style="color:#e6db74">&#34;azurerm_subnet&#34; &#34;example&#34;</span> {
  name                 <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">subnet_name</span>
  resource_group_name  <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">resource_group_name</span>
  virtual_network_name <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">virtual_network_name</span>
}<span style="color:#75715e">
</span><span style="color:#75715e">
</span><span style="color:#75715e">
</span><span style="color:#75715e"># ~~~~~~    main.tf     ~~~~~~
</span><span style="color:#75715e"></span><span style="color:#66d9ef">module</span> <span style="color:#e6db74">&#34;vnet&#34;</span> {<span style="color:#75715e">
</span><span style="color:#75715e">  # ... (details omitted)
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;azurerm_network_interface&#34; &#34;example&#34;</span> {<span style="color:#75715e">
</span><span style="color:#75715e">  # note subnet_id is bound to a data block, by way of the vnet module
</span><span style="color:#75715e"></span>  subnet_id      <span style="color:#f92672">=</span> <span style="color:#66d9ef">module</span>.<span style="color:#66d9ef">vnet</span>.<span style="color:#66d9ef">subnet1</span>.<span style="color:#66d9ef">id</span>

  depends_on <span style="color:#f92672">=</span> [<span style="color:#66d9ef">module</span>.<span style="color:#66d9ef">vnet</span>]
}
</code></pre></div><p>We have introduced a <code>vnet</code> module, which outputs the long, ugly subnet ID into a convenient variable. And use it, of course. Harmless, right? Let&rsquo;s look at what <code>terraform plan</code> tells us now:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#75715e"># (the following is a partial `terraform plan` output)
</span><span style="color:#75715e">
</span><span style="color:#75715e"># resource.azurerm_network_interface.example must be replaced
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">-/+</span> <span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;azurerm_network_interface&#34; &#34;example&#34;</span> {
  subnet_id           <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;...(omitted for space)...&#34;</span> <span style="color:#960050;background-color:#1e0010">-&gt;</span> (<span style="color:#66d9ef">known</span> <span style="color:#66d9ef">after</span> <span style="color:#66d9ef">apply</span>)<span style="color:#75715e"> # forces replacement
</span><span style="color:#75715e">
</span><span style="color:#75715e">  # ... (omitted)
</span><span style="color:#75715e"></span>}
</code></pre></div><p>The key phrase here that has burned itself into my retinas and haunts me at night is <code>-&gt; (known after apply) # forces replacement</code>. And congratulations, we&rsquo;re about to <strong>replace all our infrastructure</strong>!</p>
<p>That&rsquo;s a bad thing.</p>
<h4 id="explanation">Explanation</h4>
<p>So let&rsquo;s walk through what happened, to the best of my understanding.</p>
<ol>
<li>We have resources in terraform.</li>
<li>Those resources rely directly or indirectly on data blocks.</li>
<li>The data blocks are in a module, and we explicitly <code>depends_on</code> that module.</li>
<li>Presumably (speculating), terraform can&rsquo;t know the value of the output of the module until later than usual&ndash;<strong>during apply of the module</strong>&ndash;and because of this, it doesn&rsquo;t know if values will change.</li>
<li>Therefore, it chooses the only predictable choice, and assumes that yes, the value will change.</li>
<li>And if this forces replacement of an entire resource, well, so be it.</li>
<li>Anyway a big chunk of our infrastructure is now cursed by the dreaded <code>-&gt; (known after apply) # forces replacement</code> message.</li>
<li>And though I haven&rsquo;t tested it, according to the GitHub Issue at <a href="https://github.com/hashicorp/terraform/issues/28377">https://github.com/hashicorp/terraform/issues/28377</a> - terraform is <strong>not bluffing</strong> and will indeed destroy and replace our resources.</li>
</ol>
<h4 id="alternate-explanations">Alternate Explanations</h4>
<p>There are two succinct, authoritative answers on the GitHub Issue thread explaining what&rsquo;s happening:</p>
<ul>
<li><a href="https://github.com/hashicorp/terraform/issues/28377#issuecomment-820398608">First explanation</a></li>
<li><a href="https://github.com/hashicorp/terraform/issues/28377#issuecomment-824070018">Second explanation</a></li>
</ul>
<h4 id="solution-stop-using-data-blocks">Solution: Stop Using Data Blocks</h4>
<p>One solution is to stop using data blocks. Here&rsquo;s the example, &lsquo;fixed&rsquo;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#75715e">######################################
</span><span style="color:#75715e">## The Path of Enlightenment: Not Relying On Data Blocks
</span><span style="color:#75715e">######################################
</span><span style="color:#75715e">
</span><span style="color:#75715e"># subnet already exists, not managed by terraform
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;azurerm_network_interface&#34; &#34;example&#34;</span> {<span style="color:#75715e">
</span><span style="color:#75715e">  # note it&#39;s a hardcoded string - what beautiful simplicity!
</span><span style="color:#75715e"></span>  subnet_id      <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/examplerg/providers/Microsoft.Network/virtualNetworks/examplevnet/subnets/subnet1&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">
</span><span style="color:#75715e">  # ... (details omitted)
</span><span style="color:#75715e"></span>}
</code></pre></div><p>Before enlightenment: chop wood, carry water. After enlightenment: chop wood, carry water.</p>
<p>And while I&rsquo;ve hardcoded the <code>subnet_id</code> in the enlightened example above, I would (and certainly have) extracted out either a <code>local</code> variable or a module-level <code>var</code>. And there&rsquo;s certainly a guiding principle as to when to extract variables, but &hellip; (handwaving) go read a book.</p>
<h4 id="alternate-solutions-import-everything-stop-using-depends_on">Alternate Solutions: Import Everything, Stop Using depends_on</h4>
<p>There are several real, alternate solutions to consider when dealing with data blocks.</p>
<ul>
<li>Import the resource into terraform, so you can replace the data block with a <code>resource</code>. Pinocchio is a real boy now! A real boy who is managed by Terraform, with all that entails. This is probably the best solution, so long as you&rsquo;re able to make it happen.</li>
<li>As the GitHub Issue mentions, avoid <code>depends_on</code>, especially if you don&rsquo;t need it.</li>
</ul>
<h4 id="more-solutions">More &ldquo;Solutions&rdquo;</h4>
<p>Here are some other things to consider.</p>
<ul>
<li>&ldquo;Hello, Pulumi Incorporated? Yes? I hear you like both <strong>customers</strong> and <strong>money</strong>? Yes? That&rsquo;s great! I&rsquo;ll be right over!&rdquo;</li>
<li>Move into the mountains, live off of the land, make your own clothes. Don&rsquo;t worry about medical care, just crush up leaves and rub them on whatever&rsquo;s ailing you, and breathe in that fresh mountain air. Invigorating! Use your old work laptop as part of the shelter&ndash;a constant reminder of the old world and why you left it behind. If you&rsquo;re honest, it&rsquo;s miserable in the wild, but at least you don&rsquo;t have to deal with Terraform. That&rsquo;s what you tell yourself as you rub more crushed leaves on the rash. The rash is still growing, and it&rsquo;s starting to burn now more than itch. It&rsquo;s cold. Cold in the mountains.</li>
</ul>
<h4 id="political-advocacy-and-a-cry-for-help">Political Advocacy and a cry for help</h4>
<p>I have several things to say:</p>
<ol>
<li>Political advocacy: I blame HashiCorp for casually tossing data blocks around in the documentation. Put a stern warning in there, Hashicorp. These things are <em>productivity landmines</em>.</li>
<li>Hashicorp: seriously, these things are dangerous. <code>terraform validate</code> should warn me for every single data block I use. Sure, some data blocks can be used safely, as can sticks of dynamite. But let&rsquo;s put some guardrails on these things, okay?</li>
<li>Am I missing something? I feel like I&rsquo;m missing something obvious, and I wasted all this time writing up the issue, when (<em>insert your simple explanation</em>). Seriously, let me know if I&rsquo;m doing something wrong. @pseale on twitter or <code>peter</code> <code>@</code> <code>pseale.com</code>.</li>
</ol>
<h4 id="tldr-with-bullet-points-and-few-words">tl;dr with bullet points and few words</h4>
<ul>
<li>Terraform data sources scary, sometimes make big boom</li>
<li>Thus, avoid</li>
<li>Import as resource instead</li>
<li>Or, hardcode instead</li>
<li>Am I crazy?</li>
</ul>

            </div>
            <div class="post-footer">
              
            </div>
          </article>
        </li>
      
        <li class="posts-list-item">
          <article class="post">
            <header class="post-header">
              <a class="posts-list-item-title" href="https://devsecfailureops.com/hot-takes/posts/expert-wsl/"><h2 class ="post-title">Expert WSL: soup-to-nuts</h2></a>
              <div class="post-meta">
                <div>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
                  
                </div>
              </div>
            </header>
            <div class="post-content">
              <h5 id="spicy-peppers-rating-system-----zero-peppers--mild-and-nutritious-blandly-educational">Spicy Peppers Rating System | 🚫 - Zero Peppers | Mild and Nutritious; Blandly Educational</h5>
<p>Covered here:</p>
<ul>
<li>what WSL is, and how to install it</li>
<li><strong>astonishingly useful WSL tips!</strong></li>
<li>ugly network troubleshooting</li>
<li>boring, specialized topics that target 1% of you. 99% of you will be totally bored, but the remaining 1% will weep for joy</li>
</ul>
<h3 id="introduction-what-is-wsl-and-how-is-it-useful">Introduction: What is WSL, and how is it useful?</h3>
<p>WSL, the Windows Subsystem for Linux, is a <strong>surprisingly easy-to-install, convenient</strong> way to run Linux on Windows.</p>
<p>I use WSL to:</p>
<ul>
<li>ssh</li>
<li>test and develop shell scripts</li>
<li>run curl, base64, openssl, and whatnot</li>
<li>run seedy bash one-liners I found on the internet</li>
<li>run Windows-incompatible tools - most notably, TUIs like <code>tig</code> don&rsquo;t run in Windows</li>
<li>configure neovim plugins for 7-20 hours every week (this is a joke, don&rsquo;t hurt me)</li>
</ul>
<p>All of these things can be done without WSL, but it&rsquo;s <strong>less effort</strong> to go with the flow and say, run ssh as nature intended. As a real example, every complex <code>kubectl</code> script I&rsquo;ve seen was written in bash. And sure, you can convert those scripts to PowerShell, or you can somehow run bash directly on Windows&hellip;but why? <strong>It&rsquo;s easier in WSL</strong>.</p>
<p>WSL is also well-isolated, such that I have already installed, deleted, migrated, reinstalled, and re-reinstalled distros without issue. In other words, WSL doesn&rsquo;t do spooky things to your host like 👻👻👻cygwin👻👻👻 does. Spoken in love, cygwin.</p>
<h3 id="installing-wsl-itself">Installing: WSL itself</h3>
<p>As of 2022, installing WSL2 is as simple as running (as Administrator) <code>wsl --install</code> if you&rsquo;re lucky. Read this if you&rsquo;re not lucky: <a href="https://docs.microsoft.com/en-us/windows/wsl/install#install">https://docs.microsoft.com/en-us/windows/wsl/install#install</a></p>
<p>You will need to Enable Virtualization in your BIOS if it isn&rsquo;t already enabled. Good luck. Everyone&rsquo;s BIOS is different. These instructions are good: <a href="https://bce.berkeley.edu/enabling-virtualization-in-your-pc-bios.html">https://bce.berkeley.edu/enabling-virtualization-in-your-pc-bios.html</a>. Personally, my expert technique to access the BIOS menu is to reboot and use both hands to repeatedly tap <code>Del</code>, <code>F1</code>, <code>F2</code>, <code>F8</code>, <code>F9</code>, <code>F12</code> all together like a complex piano chord, as quickly as possible, while thinking happy thoughts.</p>
<p>Beware of older, outdated instructions for installing WSL1 and even WSL2. And in full disclosure, I&rsquo;m writing this sentence in April 2022, and I&rsquo;m sure my instructions will similarly fall out of date. In the future you&rsquo;ll spend 45 minutes begging your Windows Store Personal GAN Shopping Assistant to install WSL, and it won&rsquo;t, of course. Anyway good luck in the future.</p>
<h3 id="installing-a-linux-distro">Installing: a linux distro</h3>
<p>Installing a specific distro happens through the Windows Store. I don&rsquo;t know why, either. Maybe forcing die-hard CLI advocates to install their favorite GPL-licensed distro through the comically commercialized Windows Store is a kind of joke? Well, intentional or no, it&rsquo;s hilarious.</p>
<p>If you don&rsquo;t know which distro to install, <strong>pick the most recent version of Ubuntu.</strong> And if you think you want to argue with this deliberately simplistic advice, then you are <strong>definitely</strong> not the target audience for it. Go in peace.</p>
<p>I should also point out that you can use the CLI to install a limited selection of distros:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># list available distros - more are available through the Windows Store than here</span>
wsl --list --online

<span style="color:#75715e"># install kali-linux</span>
wsl --install -d kali-linux
</code></pre></div><h3 id="surprisingly-useful-things">Surprisingly useful things</h3>
<p>WSL can launch Windows programs and use them in pipelines. There are some great things you can do with this <em>synergy</em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># launch Windows Explorer here - three ways</span>
cmd.exe /c start .
explorer.exe
powershell.exe -Command ii .

<span style="color:#75715e"># works on links too</span>
cmd.exe /c start https://google.com/search?q<span style="color:#f92672">=</span>expert+wsl+devsecfailureops

<span style="color:#75715e"># pipe directly to the Windows clipboard</span>
echo <span style="color:#e6db74">&#34;hunter2&#34;</span> | base64 | clip.exe
</code></pre></div><p>You can also run WSL processes in your PowerShell pipeline, but I haven&rsquo;t found many good uses for it. I guess I could do something like the following? Anyway, it&rsquo;s possible.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># base64-encode whatever&#39;s on the clipboard, and put that back on the clipboard</span>
Get-Clipboard | wsl base64 | Set-Clipboard
</code></pre></div><h3 id="accessing-files">Accessing files</h3>
<p>Windows can access the WSL distro&rsquo;s filesystem, and the WSL distro can access Windows' filesystem.</p>
<p><strong>From Windows:</strong></p>
<ul>
<li>Files in WSL are accessible. By example, the full path for <code>\\wsl$\Ubuntu-20.04\home\p\.bashrc</code> is formed as such:
<ul>
<li><code>\\wsl$\Ubuntu-20.04</code> accesses the root of the Ubuntu 20.04 filesystem</li>
<li><code>/home/p/.bashrc</code> is the path within that filesystem</li>
<li>thus <code>\\wsl$\Ubuntu-20.04</code> + <code>/home/p/.bashrc</code> -&gt; <code>\\wsl$\Ubuntu-20.04\home\p\.bashrc</code></li>
</ul>
</li>
<li><code>cd \\wsl$\Ubuntu-20.04</code> works in PowerShell, and even cmd.exe has limited support for UNC-style paths</li>
<li>Accessing <code>\\wsl$</code> from the Explorer address bar lets you lazily navigate around WSL with the mouse and other GUI affordances&ndash;*audible gasp* BUT I WOULD NEVER! I haven&rsquo;t touched my mouse since 2018, I swear! And that was an accident!</li>
</ul>
<p><strong>From WSL:</strong></p>
<ul>
<li>Files in Windows are accessible. By example, the full path for <code>/mnt/c/Users/p/Desktop/passwords.txt</code> is formed as such:
<ul>
<li><code>/mnt/c</code> accesses the root of the C: (all Windows drives are mounted to <code>/mnt/&lt;driveletter&gt;</code>)</li>
<li><code>\Users\p\Desktop\passwords.txt</code> is the path from within C:</li>
<li>thus <code>/mnt/c</code> + <code>\Users\p\Desktop\passwords.txt</code> -&gt; <code>/mnt/c/Users/p/Desktop/passwords.txt</code></li>
</ul>
</li>
<li>Windows paths referenced from WSL are <strong>case-sensitive</strong>. This is easier to remember once you&rsquo;ve been burned by it 3-4 times (or 300-400 maybe).</li>
</ul>
<h3 id="wslexe-usage">wsl.exe usage</h3>
<p>Here are the specific things I&rsquo;ve done with <code>wsl.exe</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># start default distro and launch shell</span>
<span style="color:#75715e"># also kicks the WSL subsystem into gear if WSL&#39;s not running, for whatever reason</span>
wsl

<span style="color:#75715e"># list - useful if you&#39;re playing around with multiple distros, or don&#39;t know what you&#39;re doing</span>
<span style="color:#75715e"># I should point out that you can simultaneously install multiple distros</span>
wsl --list

<span style="color:#75715e"># shutdown</span>
wsl --shutdown
</code></pre></div><p>You can quickly invoke the WSL shell via wsl.exe. The details are explained by example below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># both   --exec   and   (any unrecognized parameter)   run a command in the WSL distro</span>
<span style="color:#75715e"># everything after   --   is delegated to the WSL distro</span>
wsl --exec echo <span style="color:#e6db74">&#34;I&#39;m in unix! PowerShell version: </span>$($PSVersionTable.PSVersion)<span style="color:#e6db74"> &lt;--evaluated in PowerShell in Windows&#34;</span>
wsl ls -al
wsl -- ls -al


<span style="color:#75715e"># SUBTLE DIFFERENCE BELOW - PAY ATTENTION:</span>

<span style="color:#75715e"># these echo back       WSL distro: Ubuntu-20.04</span>
wsl echo <span style="color:#e6db74">&#34;WSL distro: </span><span style="color:#ae81ff">`$</span><span style="color:#e6db74">{WSL_DISTRO_NAME}&#34;</span>
wsl -- echo <span style="color:#e6db74">&#34;WSL distro: </span><span style="color:#ae81ff">`$</span><span style="color:#e6db74">{WSL_DISTRO_NAME}&#34;</span>

<span style="color:#75715e"># this echoes back      WSL Distro: ${WSL_DISTRO_NAME}</span>
wsl --exec echo <span style="color:#e6db74">&#34;WSL Distro: </span><span style="color:#ae81ff">`$</span><span style="color:#e6db74">{WSL_DISTRO_NAME}&#34;</span>
</code></pre></div><h3 id="seamless-text-editing-vs-code">Seamless Text Editing: VS Code</h3>
<p>VS Code (running in Windows) seamlessly edits files in WSL2, so long as you&rsquo;ve installed either the <code>Remote - WSL</code> extension, or the <code>Remote Development</code> extension.</p>
<p>To painlessly launch VS Code from within the WSL filesystem, do the same as anywhere else:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># In WSL, this works the same for the end-user (you), but does very different things under the hood</span>
code .
</code></pre></div><h3 id="seamless-terminal-experience-windows-terminal">Seamless Terminal Experience: Windows Terminal</h3>
<p>I launch the Ubuntu 20.04 shell in a new tab in Windows Terminal with <code>CTRL</code> + <code>SHIFT</code> + <code>2</code>. Windows Terminal is highly configurable, so your hotkeys may vary.</p>
<p>Small nitpick: there are occasional display bugs in Windows Terminal. I&rsquo;ve noticed too&ndash;it&rsquo;s not just you.</p>
<h3 id="wsl-turning-it-off-and-on-again">WSL: Turning it off and on again</h3>
<p>There are two options here: the one you hope works, and the one you know works. WSL&rsquo;s <code>--shutdown</code> command is usually effective.</p>
<ul>
<li>The option you hope works: <code>wsl --shutdown</code> followed by <code>wsl</code></li>
<li>The option you know works, for certain: reboot Windows (sorry)</li>
</ul>
<h3 id="wsl-uses-ram">WSL uses RAM</h3>
<ul>
<li>If you&rsquo;re running WSL on a Windows OS with only 16GB of RAM, consider upgrading to 32GB. With 16GB, you&rsquo;re likely using all your RAM and relying on swap. This will slow you down noticeably. I mean, yes, we mostly blame Chrome and curse the day Electron was invented, and they&rsquo;re the worst offenders. I&rsquo;m just saying that once you start running containers or VMs on 16GB of RAM, you&rsquo;re done. You&rsquo;re done.</li>
<li>WSL2 appears as <code>Vmmem</code> in Task Manager. Ubuntu 20.04 on my machine is currently using just under 2GB of RAM.</li>
<li>To check available RAM, look at Performance-&gt;Memory in Task Manager.</li>
</ul>
<h3 id="boring-and-necessary-networking-issues">Boring and Necessary: Networking issues</h3>
<p>Listen up! Networking in WSL is magic. And by magic I mean opaque, mysterious, fickle, and moody. I&rsquo;ve done several things to fix networking issues:</p>
<ul>
<li>If DNS dies regularly in WSL, fix it permanently with this WSL-specific change: <a href="https://superuser.com/a/1533768">https://superuser.com/a/1533768</a></li>
<li>Set MTU to 1400 - I would love to explain this further, but in short, I can&rsquo;t. Good luck, and if you google your mysterious networking-related error message and some of the first results are for setting the &lsquo;MTU&rsquo;, then try it, certainly. The last time I saw this error, someone was trying to clone a git repo.</li>
</ul>
<h3 id="boring-and-necessary-line-endings">Boring and Necessary: Line endings</h3>
<p>This is a really boring topic, but if you need it, you need it.</p>
<p>Git for Windows is probably checking out files with CRLF line endings (the specifics are here: <a href="https://docs.github.com/en/get-started/getting-started-with-git/configuring-git-to-handle-line-endings)">https://docs.github.com/en/get-started/getting-started-with-git/configuring-git-to-handle-line-endings)</a>. For most of us, if you commit files in Windows, push to GitHub, and pull them down in WSL, the line endings are LF in WSL and CRLF in Windows, which is probably what you want. However, if you&rsquo;re manipulating/accessing files across Linux and Windows boundaries, consider several solutions to tackling the line ending problem:</p>
<ul>
<li><code>dos2unix</code> to manually convert a file from LF to CRLF, or CRLF to LF, from inside WSL</li>
<li>Manually load and change line endings in your text editor. E.g. in VS Code in the status bar, it will indicate either LF or CRLF. You can change this by clicking on the LF (or CRLF) indicator in the status bar, or from the Command Palette: <code>&gt;Change End of Line Sequence</code>.</li>
</ul>
<p>More permanent, team-friendly defaults:</p>
<ul>
<li>set <code>.gitattributes</code> in individual repos to always checkout some file types (e.g. shell scripts) as LF</li>
<li>set <code>.gitattributes</code> in specific repos to always checkout all files as LF</li>
</ul>
<p>More permanent defaults for your git install (only affects you, not the team):</p>
<ul>
<li>via <code>git config --global core.autocrlf</code></li>
<li>via <code>git config --global core.eol</code></li>
</ul>

            </div>
            <div class="post-footer">
              
            </div>
          </article>
        </li>
      
        <li class="posts-list-item">
          <article class="post">
            <header class="post-header">
              <a class="posts-list-item-title" href="https://devsecfailureops.com/hot-takes/posts/command-palette-everywhere/"><h2 class ="post-title">Command Palettes (Omnisearch) Everywhere</h2></a>
              <div class="post-meta">
                <div>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
                  
                </div>
              </div>
            </header>
            <div class="post-content">
              <h5 id="spicy-peppers-rating-system-----zero-peppers--inoffensive-and-sincere">Spicy Peppers Rating System | 🚫 - Zero Peppers | Inoffensive and Sincere</h5>
<h3 id="summary">Summary</h3>
<ol>
<li>Command Palettes let you search for and run commands by descriptive name.</li>
<li>Thus for rare or obscure tasks, using the Command Palette is much easier than hunting down commands in <code>Nested-&gt;Edit-&gt;Menus</code> or memorizing arcane key chords. This is a big productivity boost, and I&rsquo;m the only person I know who does this. You people are doing it all wrong! &ldquo;You people are doing it all wrong&rdquo; is generally true, <em>but I digress.</em></li>
<li>Command Palettes are in every major text editor and IDE.</li>
<li>They&rsquo;re also in weird places like Windows Terminal and Chrome Developer Tools.</li>
</ol>
<h3 id="by-example">By example</h3>
<p>In VS Code, I sometimes run <code>&gt;Format Document</code>. I know this is available through either a deeply nested <code>File-&gt;Etc</code> menu or a hotkey.</p>
<p>In the case of <code>Format Document</code>, it is apparently bound by default to <code>ALT</code>+<code>SHIFT</code>+<code>F</code>. Reasonable, but unmemorable for something I do rarely in my part-time text editor. In days of yore, I might have tried to memorize this keybind! Or worse, ｃｕｓｔｏｍｉｚｅ ｍｙ ｋｅｙｂｉｎｄｓ!</p>
<p>But now that I&rsquo;ve acclimated to relying on Command Palettes, I&rsquo;ll open the Command Palette, lazily type a few letters of <code>format</code>, lazily arrow up and down, lazily press <code>ENTER</code>, lazily be done with it. And all effortlessly, without expending my precious brain energy!</p>
<h3 id="command-palettes-give-your-brain-a-break">Command Palettes: Give your brain a break</h3>
<p><code>Format Document</code> is just one example of something I do once a month or so. I&rsquo;ve also messed with BOM encodings via <code>Change File Encoding</code>, fiddled with with line endings via <code>Change End of Line Sequence</code>, and even used the <code>Fold</code> command to collapse some XML that one time!</p>
<p>In Windows Terminal, I&rsquo;ve split the terminal pane so I could watch several things at once. Thanks to the Command Palette, I didn&rsquo;t have to hunt down the settings and memorize <code>ALT</code>+<code>SHIFT</code>+<code>+</code>. Instead, I put my brain on vacation, opened the Command Palette, searched for <code>split</code>, ran it, and moved on with my life.</p>
<h3 id="your-ide-and-you">Your IDE and You</h3>
<p>Command Palettes are available in:</p>
<ol>
<li><a href="https://docs.sublimetext.io/guide/extensibility/command_palette.html">Sublime Text</a> - the original!</li>
<li><a href="https://code.visualstudio.com/docs/getstarted/userinterface#_command-palette">VS Code</a> - VS Code did a great job harvesting Sublime Text&rsquo;s best features, and the Command Palette is one such feature. Well done, thieves!</li>
<li><a href="https://docs.microsoft.com/en-us/visualstudio/ide/visual-studio-search?view=vs-2019">Visual Studio</a> - here it is called Search</li>
<li><a href="https://www.jetbrains.com/help/rider/Navigating_to_Action.html">JetBrains Products</a> - here it is available through either Find Action, or Search Everywhere&ndash;either will do the trick</li>
<li><a href="https://developer.chrome.com/docs/devtools/command-menu/">Google Chrome Dev Tools</a> - here it is called Command Menu</li>
<li><a href="https://docs.microsoft.com/en-us/windows/terminal/command-palette">Windows Terminal</a> - as weird as it sounds, the Command Palette exists here!</li>
<li><a href="https://superuser.com/q/671149">Vim</a> - as with all things Vim, there are many paths up the mountain, none of which is the &lsquo;true&rsquo; one. Vim plugin universalism: you heard it here first.</li>
</ol>
<h3 id="command-palette-conventions">Command Palette Conventions</h3>
<ol>
<li>I have the Command Palette bound to <code>CTRL</code>+<code>SHIFT</code>+<code>P</code> everywhere. This is already the default keybind in many places. MacOS users: as with all things, mentally replace <code>CTRL</code> with <code>CMD</code>.</li>
<li>Similarly, <code>CTRL</code>+<code>P</code> should navigate to files. MacOS: <code>CMD</code>+<code>P</code>.</li>
<li>Command Palettes support a kind of forgiving fuzzy search<!-- raw HTML omitted -->[1]<!-- raw HTML omitted --> syntax and a convenient dropdown list of commands. If you&rsquo;ve never seen this before, the key word here is <strong>fuzzy</strong>. It&rsquo;s fuzzy search. It&rsquo;s not strict.</li>
<li>The Command Palette shows keybinds (if any exist) for the command. Use the Command Palette like a cheatsheet.</li>
<li>VS Code, JetBrains, and Google Chrome support mode swapping through the addition or removal of the <code>&gt;</code> prefix. So, by example:
<ul>
<li>Searching for <code>&gt;format</code> gives the <code>Format Document</code> command</li>
<li>Searching for <code>format</code> without the <code>&gt;</code> prefix gives <code>formatter.js</code>.</li>
</ul>
</li>
</ol>
<h4 id="footnotes">Footnotes:</h4>
<p><!-- raw HTML omitted --><!-- raw HTML omitted -->
[1] Is Command Palette fuzzy search fuzzy like <code>fzf</code>? Who can say? Not I! Not I.
<!-- raw HTML omitted --><!-- raw HTML omitted --></p>

            </div>
            <div class="post-footer">
              
            </div>
          </article>
        </li>
      
        <li class="posts-list-item">
          <article class="post">
            <header class="post-header">
              <a class="posts-list-item-title" href="https://devsecfailureops.com/hot-takes/posts/standard-disclaimer/"><h2 class ="post-title">Standard Disclaimer</h2></a>
              <div class="post-meta">
                <div>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
                  
                </div>
              </div>
            </header>
            <div class="post-content">
              <p>Welcome! I&rsquo;m Peter, and I&rsquo;m here to:</p>
<ul>
<li>get a load off my chest</li>
<li>write some spicy 🌶🌶🌶 hot takes</li>
<li>have some fun</li>
<li>make some jokes</li>
<li>sometimes make a serious point</li>
<li>but also bury that serious point in a nuclear-grade take 💣</li>
</ul>
<p>You&rsquo;re here to:</p>
<ul>
<li>learn something</li>
<li>be entertained</li>
<li>be enraged</li>
<li>sample a Neopolitan-esque combination of all three flavors. Let&rsquo;s call this edu-tain-ragement. Edutainragement. Flows off the tongue.</li>
</ul>
<p>I don&rsquo;t take myself, these hot takes, or this blog too seriously. Enjoy!</p>
<h3 id="spicy-peppers-rating-system">Spicy Peppers Rating System</h3>



<style>
    #spicy-peppers-rating-system-table {
        font-size: 0.85em;
        background: #57cc8a;
        border-collapse:collapse
    }

    #spicy-peppers-rating-system-table tr {
    }
    #spicy-peppers-rating-system-table td {
        border: 2px solid white;
        color: white;
        padding: 0 5px;
    }
    #spicy-peppers-rating-system-table td.peppers {
        white-space: nowrap; /* we can afford the horizontal space to force all the peppers into a single line */
    }

</style>

<table id="spicy-peppers-rating-system-table">
<tr>
  <td>🚫</td>
  <td>Informational, educational, earnest.</td>
</tr>
<tr>
  <td class="peppers">🌶</td>
  <td>A burst of zesty flavor. Delicious and stimulating! May cause mild intestinal discomfort.</td>
</tr>
<tr>
  <td class="peppers">🌶🌶</td>
  <td>Controversial, unpopular take; may hurt feelings. Spoken in love. The Goldilocksian mama bear of hot takes.</td>
</tr>
<tr>
  <td class="peppers">🌶🌶🌶</td>
  <td>I'm probably having a lot of fun with this one. Immediately proceed to eyewash station and flush to avoid permanent damage.</td>
</tr>
</table>




            </div>
            <div class="post-footer">
              
            </div>
          </article>
        </li>
      
    </ul>
    



  </div>

    </main>
  </body>
</html>
